<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="左未的blog">
<meta property="og:type" content="website">
<meta property="og:title" content="左未的blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="左未的blog">
<meta property="og:description" content="左未的blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="左未的blog">
<meta name="twitter:description" content="左未的blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>左未的blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">左未的blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-spinner"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-关于">
          <a href="/aboutme" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/14/【计算机图形学基础】二 射线追踪/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/14/【计算机图形学基础】二 射线追踪/" itemprop="url">【计算机图形学基础】二 射线追踪</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-14T15:53:28+08:00">
                2019-02-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/计算机图形学/" itemprop="url" rel="index">
                    <span itemprop="name">计算机图形学</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/02/14/【计算机图形学基础】二 射线追踪/" class="leancloud_visitors" data-flag-title="【计算机图形学基础】二 射线追踪">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="【计算机图形学基础】二-射线追踪"><a href="#【计算机图形学基础】二-射线追踪" class="headerlink" title="【计算机图形学基础】二 射线追踪"></a>【计算机图形学基础】二 射线追踪</h1><p>该系列为阅读书籍<a href="https://book.douban.com/subject/3829906/" target="_blank" rel="noopener">Fundamentals Of Computer Graphics</a>所做的笔记。</p>
<p>本篇对应书中第四章<strong>Ray Tracing</strong>。</p>
<p>由两种渲染方式：一种是逐个画物体；一种是逐个画像素。前者是遍历所有物体；后者是遍历所有的像素，以及影响该像素的物体。射线追踪属于后者。</p>
<p>关于二者的区别，在<a href="http://vr.cs.uiuc.edu/node191.html" target="_blank" rel="noopener">这个网站</a>可以看到有这么一段解释：</p>
<blockquote>
<p>For rendering, we need to consider all combinations of objects and pixels. This suggests a nested loop. One way to resolve the visibility is to iterate over the list of all triangles and attempt to render each one to the screen. This is called object-order rendering, and is the main topic of Section 7.2. For each triangle that falls into the field of view of the screen, the pixels are updated only if the corresponding part of the triangle is closer to the eye than any triangles that have been rendered so far. In this case, the outer loop iterates over triangles whereas the inner loop iterates over pixels. The other family of methods is called image-order rendering, and it reverses the order of the loops: Iterate over the image pixels and for each one, determine which triangle should influence its RGB values. To accomplish this, the path of light waves that would enter each pixel is traced out through the virtual environment. This method will be covered first, and many of its components apply to object-order rendering as well.</p>
</blockquote>
<p>就是说imgage-order rendering逐像素渲染，外面一层的loop的对象是所有像素，里面一层的loop对象是三角形，里面一层会判断在该像素点的哪个三角形离观察者最近，并渲染它。（深度测试的原理）</p>
<h2 id="基础的射线追踪算法"><a href="#基础的射线追踪算法" class="headerlink" title="基础的射线追踪算法"></a>基础的射线追踪算法</h2><p>从观察者发送一束射线到目标像素点，命中的第一个三角形，将会被绘制。</p>
<p>因此一个基础的射线追踪器分为三个部分：</p>
<ol>
<li>产生射线，决定射线的原点以及方向</li>
<li>射线交点，找到与射线交点最近原点的物体</li>
<li>绘制(shading)，绘制该交点的颜色</li>
</ol>
<p>伪代码可以表现为</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> 每个像素 <span class="keyword">do</span></span><br><span class="line">  计算视觉射线</span><br><span class="line">  找到第一个被射线击中的物体表面以及它的法向量$n$</span><br><span class="line">  根据交点的法向量和光照等信息，计算出该像素点的颜色</span><br></pre></td></tr></table></figure>
<h2 id="透视"><a href="#透视" class="headerlink" title="透视"></a>透视</h2><p>透视有很多种，比如立体透视和鱼眼透视，但是我们最常用的还是线性透视。在线性透视中，3d物体被<strong>投影</strong>到一块平面上，原来是直线的，投影完还是直线（反例是鱼眼透视，会变形）。</p>
<p>最简单的投影类型是平行投影，其实就是让3d物体沿着视觉平面的法向量方向运动，直到3d物体击中视觉平面。<br>平行投影的两种：如果图像平面正交于视觉方向，这种投影就叫正交投影，否则叫斜投影(oblique)</p>
<img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/1.png" title="可以看到眼睛在左边，右边的平面并不垂直于眼睛">
<p>透视和平行投影不同，万物在远处会变小直至消失，平行线在远处会交汇。</p>
<h2 id="计算视觉射线"><a href="#计算视觉射线" class="headerlink" title="计算视觉射线"></a>计算视觉射线</h2><p>一条射线的数学表达为：</p>
<p>$$p(t)=e+t(s-e)$$</p>
<p>其中，e为射线原点，s为平面上的一点。当t为0，则在e点上，当t为1，则在s点上。</p>
<h3 id="正交视角"><a href="#正交视角" class="headerlink" title="正交视角"></a>正交视角</h3><img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/2.png" title="看w的方向">
<blockquote>
<p>Camera Frame<br>在OpenGl编程里常可以看到这个词，代表相机方向和位置。<br><img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/3.png" title="相机帧"></p>
</blockquote>
<p>-w垂直于锥形体的上底。我们得知了点e和上底的距离d（在正交视角中，d为0，<strong>e</strong>在屏幕上），以及像素点的坐标，就可以算出射线的向量。</p>
<p>这里假设锥形体上底这个面中，l为屏幕左边缘的位置，右r，上t，下b。那么屏幕的大小就为(r - l) x (t - b)。</p>
<img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/4.png" title="计算射线向量">
<p>假设屏幕上一行有$n_x$个像素，一列有$n_y$行像素，那么第(i, j)个像素的坐标在u方向和v方向上的位置分别为：</p>
<p>$$u = l + (i + 0.5)(r - l) / n_x$$<br>$$v = l + (j + 0.5)(t - b) / n_y$$</p>
<p>那么射线就可以表达为：</p>
<p>射线方向 -w 平行视角，全部都是这样的</p>
<p>射线起点 <strong>e</strong> + $u$<strong>u</strong> + $v$<strong>v</strong></p>
<h3 id="透视视角"><a href="#透视视角" class="headerlink" title="透视视角"></a>透视视角</h3><img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/5.png" title="计算射线向量">
<p>和正交视角不同，透视视角的射线为：</p>
<p>射线方向 -d<strong>w</strong> + $u$<strong>u</strong> + $v$<strong>v</strong></p>
<p>射线起点 <strong>e</strong></p>
<h2 id="射线与物体的交汇"><a href="#射线与物体的交汇" class="headerlink" title="射线与物体的交汇"></a>射线与物体的交汇</h2><p>假设射线可以用一个一元一次方程表达（类似于y = b + kx)，表示为 <strong>p</strong>(t) = <strong>e</strong> + t<strong>d</strong>，求它跟面f(<strong>p</strong>) = 0的交点。</p>
<h3 id="射线与球的交点"><a href="#射线与球的交点" class="headerlink" title="射线与球的交点"></a>射线与球的交点</h3><p>设球的重点为c，球可以表示为</p>
<p>$$(x - x_c)^2 + (y - y_c)^2 + (z - z_c)^2 - R^2 = 0$$</p>
<p>把它写成向量的形式就是</p>
<p>$$\textbf{(p - c)(p - c)} - R^2 = 0$$</p>
<p>其中，<strong>p</strong>为球面上的一点。如果我们把射线方程中的<strong>p</strong>带入到球的向量表达式中，可以得到</p>
<p>$$(\textbf{e} + t\textbf{d} - \textbf{c})^2 - R^2 = 0$$</p>
<p>拆出来得到一个关于$t$的二元一次方程：</p>
<p>$$(\textbf{d}\cdot\textbf{d})t^2 + 2\textbf{d}\cdot(\textbf{e} - \textbf{c})^t + (\textbf{e} - \textbf{c})^2 - R^2 = 0$$</p>
<p>最后根据二元一次方程的解法算出$t$。</p>
<h3 id="射线与三角形的交点"><a href="#射线与三角形的交点" class="headerlink" title="射线与三角形的交点"></a>射线与三角形的交点</h3><blockquote>
<p>先复习一波重心法<br><img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/7.png" title="重心法"><br>三角形中的任意两个顶点，可以由第三个顶点的位移来表示。<br>如果一个点$\textbf{P}$在三角形内，那么它可以表示为<br>$$\textbf{P} = \textbf{A} + \gamma(\textbf{C} - \textbf{A}) + \lambda(\textbf{B} - \textbf{A})$$<br>并且要求：<br>$$\left\{<br>\begin{aligned}<br>\lambda \gt 0 \\<br>\gamma \gt 0 \\<br>\lambda + \gamma \lt 1<br>\end{aligned}<br>\right.$$</p>
<p>可以看到，当$\lambda$为1，$\gamma$为0时，点在$\textbf{B}$上，当$\lambda$为0，$\gamma$为1时，点在$\textbf{C}$上。所以必须符合$\beta + \gamma \lt 1$</p>
</blockquote>
<img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/6.png" title="三角形示意">
<p>检测射线与三角形交点的方法有很多，这里使用重心法。</p>
<p>要求解出</p>
<p>$$\textbf{e} + t\textbf{d} = \textbf{f}(u, v)$$</p>
<p>其中，等式右边表示在三角形上的点。</p>
<p>这条等式又可以表达为：</p>
<p>$$\left\{<br>\begin{aligned}<br>x_e+tx_d=f(u,v) \\<br>y_e+ty_d=g(u,v) \\<br>z_e+tz_d=h(u,v)<br>\end{aligned}<br>\right.\tag{1}<br>$$</p>
<p>在上式中，我们有3条等式和3个未知数$t, u, v$。现在已知三角形的三个点$\textbf{a}$、$\textbf{b}$和$\textbf{c}$。</p>
<p>这就得到：</p>
<p>$\textbf{e} + t\textbf{d} = \textbf{a} + \beta(\textbf{b} - \textbf{c})) + \gamma(\textbf{c} - \textbf{a})$ 式子一</p>
<p>为了解出$t,\,\beta,\,\gamma$，我们把(1)拆开得到：</p>
<p>$$x_e + tx_d = x_a + \beta(x_b - x_a) + \gamma(x_c - x_a)$$<br>$$y_e + ty_d = x_a + \beta(y_b - y_a) + \gamma(y_c - y_a)$$<br>$$z_e + tz_d = x_a + \beta(z_b - z_a) + \gamma(z_c - z_a)$$</p>
<p>写成向量的形式：</p>
<p>$$<br> \left[<br> \begin{matrix}<br>   x_a - x_b &amp; x_a - x_c &amp; x_d \\<br>   y_a - y_b &amp; y_a - y_c &amp; y_d \\<br>   z_a - z_b &amp; z_a - z_c &amp; z_d<br>  \end{matrix}<br>  \right]<br>  \left[<br> \begin{matrix}<br>   \beta \ \gamma \ t<br>  \end{matrix}<br>  \right]<br>  =<br>  \left[<br> \begin{matrix}<br>   x_a - x_e \\<br>   y_a - y_e \\<br>   z_a - z_e \\<br>  \end{matrix}<br>  \right]<br>$$</p>
<p>接下来使用<strong>克莱姆法则</strong>(Cramer’s Rule)来解决这个问题。</p>
<blockquote>
<p>？？？ 克莱姆法则又是啥玩意儿？</p>
<p>摔！！！</p>
</blockquote>
<p>好的总之最后就得到了$t,\,\beta,\,\gamma$关于几个已知点的表达式。</p>
<img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/8.png" title="结果">
<p>现在只需要判断他们是否符合几个条件，就可以直到交点在不在三角形内了。伪代码为</p>
<p>$<br>compute\,t \\<br>\textbf{if} \, (t \lt t_0) \, or \, (t \gt t_1) \, \textbf{then} \\<br>\quad \textbf{return} \, false \\<br>compute\,\gamma \\<br>\textbf{if} \, (\gamma \lt 0) \, or \, (\gamma \gt 1) \, \textbf{then} \\<br>\quad \textbf{return} \, false \\<br>compute\,\beta \\<br>\textbf{if} \, (\beta \lt 0) \, or \, (\beta \gt 1 - \lambda) \, \textbf{then} \\<br>\quad\textbf{return} false \\<br>\textbf{return}\,true<br>$</p>
<h3 id="与一组物体相♂交"><a href="#与一组物体相♂交" class="headerlink" title="与一组物体相♂交"></a>与一组物体相♂交</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hit = <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> o <span class="keyword">in</span> group <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> (o is hitAtParamT <span class="keyword">and</span> (t &gt;= t0 <span class="keyword">and</span> t&lt;= t1)) <span class="keyword">then</span></span><br><span class="line">    hit = <span class="literal">true</span></span><br><span class="line">    hitobject = o</span><br><span class="line">    t1 = t <span class="comment">-- 不断缩小范围</span></span><br><span class="line"><span class="keyword">return</span> hit</span><br></pre></td></tr></table></figure>
<h2 id="着色"><a href="#着色" class="headerlink" title="着色"></a>着色</h2><p>一旦知道一个像素点上要绘制的物体，就开始着色啦。</p>
<p>大多数模型是来模拟光照效果的。对于一个光照模型中，决定性因素有如下：</p>
<ul>
<li>光线方向 <strong>l</strong> 这是一个指向光源的单位向量</li>
<li>视觉方向 <strong>v</strong> 指向相机的单位向量</li>
<li>法向量 <strong>n</strong></li>
<li>颜色等等的表面信息</li>
</ul>
<h3 id="Lambertian着色"><a href="#Lambertian着色" class="headerlink" title="Lambertian着色"></a>Lambertian着色</h3><p>在18世纪提出来的最简单的光照模型。</p>
<img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/9.png" title="Lambertian">
<p>这里假设表面<strong>法向量</strong>与<strong>光向量</strong>的夹角为$\theta$，$k_d$为一个系数。那么，光强L等于</p>
<p>$$L = k_dI\text{max}(0, \textbf{n}\cdot\textbf{l})$$</p>
<p>其中，$L$是像素的颜色；$k_d$是漫反射系数，或者说表面颜色；$I$是光源的光强。由于<strong>n</strong>和<strong>l</strong>都是单位向量，所以我们可以把$\textbf{n}\cdot\textbf{l}$速记成$\cos\theta$。<strong>l</strong>很容易计算，我们从上一节中知道了如何计算出视线与表面的交点，算出交点之后用光源坐标减去交点坐标，再正规化即可。</p>
<p>可以表达为：</p>
<p>光强 = 因子 x 光照强度 x <strong>(法向量 与 光线 的夹角程度)</strong></p>
<p>最重要的是后面粗体部分。</p>
<p>我们可以分别对RGB三个颜色通道，使用这条公式得出结果。</p>
<h3 id="Blinn-Phong着色"><a href="#Blinn-Phong着色" class="headerlink" title="Blinn-Phong着色"></a>Blinn-Phong着色</h3><p>Lambertian着色是视角无关的，不管相机在哪个相对位置，看到的颜色都是一样的，这种着色法没办法产生<strong>高光</strong>。现在有很多着色模型把Lambertian着色作为漫反射部分，再添加一个镜面反射部分。</p>
<p>Blinn-Phong光照模型中，当<strong>v</strong>和<strong>l</strong>关于法向量对称的时候，将看到最大亮度，也就是能看到镜面反射。随着<strong>v</strong>离该方向越远，光强会慢慢下降。</p>
<img src="/2019/02/14/【计算机图形学基础】二%20射线追踪/10.png" title="镜面反射">
<p>现在沿着假定<strong>v</strong>和<strong>l</strong>夹角的等分线方向，有个单位向量<strong>h</strong>。当<strong>n</strong>与<strong>h</strong>重叠的时候，<strong>l</strong>与<strong>v</strong>将关于<strong>n</strong>对称。当$\cos \gamma$的值（这里假设$\gamma$为<strong>n</strong>与<strong>h</strong>的夹角）越小，光强越大。这里再给他们定一个幂数p，让镜面反射的衰变能够来得更猛烈一点（也就是p越大，光斑的面积会越小）。</p>
<p>我们可以计算出<strong>h</strong></p>
<p>$$\textbf{h}=\frac{\textbf{v} + \textbf{l}}{| \textbf{v} + \textbf{l} |}$$</p>
<p>最后得到光照强度：</p>
<p>$$L = k_dI\text{max}(0, \textbf{n}\cdot\textbf{l}) + k_sI\max(0, \textbf{n} \cdot \textbf{h})^p$$</p>
<h3 id="环境光着色"><a href="#环境光着色" class="headerlink" title="环境光着色"></a>环境光着色</h3><p><strong>Ambient Shading</strong>.</p>
<p>现在再多考虑一个环境光，也就是本光源以外的所有光源总和。考虑环境光是为了避免在本光源照不到的地方，乌漆嘛黑一片的巨丑。</p>
<p>$$L = k_aI_a + k_dI\text{max}(0, \textbf{n}\cdot\textbf{l}) + k_sI\max(0, \textbf{n} \cdot \textbf{n})^p$$</p>
<h3 id="多光源光照"><a href="#多光源光照" class="headerlink" title="多光源光照"></a>多光源光照</h3><p>把结果都加起来即可</p>
<p>$$L = k_aI_a + \sum_{i=1}^{N}k_dI\text{max}(0, \textbf{n}\cdot\textbf{l}_i) + k_sI\max(0, \textbf{n} \cdot \textbf{h}_i)^p$$</p>
<h2 id="阴影"><a href="#阴影" class="headerlink" title="阴影"></a>阴影</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/13/【精通Linux】一/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/13/【精通Linux】一/" itemprop="url">【精通Linux】一 概述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-13T19:04:44+08:00">
                2019-02-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/02/13/【精通Linux】一/" class="leancloud_visitors" data-flag-title="【精通Linux】一 概述">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="【精通Linux】一-概述"><a href="#【精通Linux】一-概述" class="headerlink" title="【精通Linux】一 概述"></a>【精通Linux】一 概述</h1><p>本系列是阅读<a href="https://book.douban.com/subject/26546893/" target="_blank" rel="noopener">精通Linux</a>所作之笔记。这本书的原名叫<strong>How Linux Works</strong>，半点没有精通的意思，算是本入门书。</p>
<h2 id="系统抽象层级"><a href="#系统抽象层级" class="headerlink" title="系统抽象层级"></a>系统抽象层级</h2><ul>
<li>用户进程，运行于CPU的用户模式</li>
<li>Linux内核，运行于CPU的内核模式</li>
<li>硬件</li>
</ul>
<h2 id="kernel-内核"><a href="#kernel-内核" class="headerlink" title="kernel 内核"></a>kernel 内核</h2><p>内核将内存划分为多块。每个进程都有自己的内存区块，内核会保证它只能只用自己的内存区块，无法存取其他进程的内存。</p>
<p>每次CPU切换用户进程的时候，需要先把CPU控制权交给内核，由内核来完成上下文切换。</p>
<p>为了避免一个进程访问到另一个进程的内存，现代CPU都使用了MMU（Memory Management Unit）。MMU使用了虚拟内存的内存访问机制，使得进程不是访问内存实际的物理地址，而是通过内核来访问一个虚拟地址，内核再通过映射表使得进程可以访问到内存。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/13/【计算机图形学基础】一 光栅图像/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/13/【计算机图形学基础】一 光栅图像/" itemprop="url">【计算机图形学基础】一 光栅图像</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-13T15:53:28+08:00">
                2019-02-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/计算机图形学/" itemprop="url" rel="index">
                    <span itemprop="name">计算机图形学</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/02/13/【计算机图形学基础】一 光栅图像/" class="leancloud_visitors" data-flag-title="【计算机图形学基础】一 光栅图像">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="【计算机图形学基础】一-光栅图像"><a href="#【计算机图形学基础】一-光栅图像" class="headerlink" title="【计算机图形学基础】一 光栅图像"></a>【计算机图形学基础】一 光栅图像</h1><p>该系列为阅读书籍<a href="https://book.douban.com/subject/3829906/" target="_blank" rel="noopener">Fundamentals Of Computer Graphics</a>所做的笔记。</p>
<p>本篇对应书中第三章<em>Raster Images</em>。Raster其词翻译为<em>光栅</em>，光栅这个词在字面上非常难以看出它想表达的意思。于是转而去Google它的英文释义。</p>
<p>在Google中可以看到如下：</p>
<blockquote>
<p>1930s: from German Raster, literally ‘screen’, from Latin rastrum ‘rake’, from ras- ‘scraped’, from the verb radere .</p>
</blockquote>
<p>Raster字面上的意思是<strong>屏幕</strong>。这个词来源于rake的意思<strong>掠过</strong>，和scraped的意思<strong>刮过</strong>。说到屏幕我们都会想到逐行扫描中，新的图像信息确实是一行一行掠（扫描）过去的，所以这个词的发明其实非常形象。</p>
<p>光栅可以理解成把一个图像分解成逐像素的。像素英文pixel，全称picture element，中文全称应该是图像元素，简称像素。<br>光栅显示装备包括显示器、电视和打印机，光栅输入设备有现代数码相机、扫描仪等。</p>
<p>除了光栅图像以外还有别的形式的图像，只是光栅这种形式已经非常流行了，所以现在基本图像都是光栅形式的。光栅图之外还有一种图叫做<strong>矢量图</strong>，光栅图可以转换成各种分辨率的光栅图，这是题外话了。</p>
<h2 id="光栅设备"><a href="#光栅设备" class="headerlink" title="光栅设备"></a>光栅设备</h2><blockquote>
<p><strong>生词</strong></p>
<ul>
<li>emissive 发射的</li>
<li>transmissive 递送的</li>
<li>illumiate $v.$ 照亮</li>
</ul>
</blockquote>
<ul>
<li>输出设备<ul>
<li>显示设备<ul>
<li>液晶显示屏 LCD (liquid crystal display) 原理是晶体的不同面有不同颜色，通过转动晶体可以出现不同的颜色，缺点是可视角度小</li>
<li>发光二极管屏幕 LED (light emitting diode display) 色域大，亮度高，可视角度大</li>
</ul>
</li>
<li>影印设备<ul>
<li>染料升华打印机</li>
<li>喷墨打印机</li>
</ul>
</li>
</ul>
</li>
<li>输入设备<ul>
<li>2d感应器：数字相机</li>
<li>1d感应器：平板扫描仪</li>
</ul>
</li>
</ul>
<h3 id="显示"><a href="#显示" class="headerlink" title="显示"></a>显示</h3><p>分为emissive设备和transmissive设备两种，前者常见为LED显示器，可以自发光；后者为液晶显示器，需要一个背景光源。</p>
<h3 id="影印设备-amp-输入设备"><a href="#影印设备-amp-输入设备" class="headerlink" title="影印设备&amp;输入设备"></a>影印设备&amp;输入设备</h3><p>略过不看。</p>
<h2 id="图像、像素、几何体"><a href="#图像、像素、几何体" class="headerlink" title="图像、像素、几何体"></a>图像、像素、几何体</h2><blockquote>
<p><strong>生词</strong></p>
<ul>
<li>reproduce 重现</li>
<li>idealize 理想化</li>
<li>notion 概念</li>
</ul>
</blockquote>
<p>这里先贴上一篇文章<a href="https://www.quora.com/Whats-the-difference-between-a-picture-image-and-photo" target="_blank" rel="noopener">单词image、picture和photo有什么区别</a>。</p>
<p>可以简单地说，picture这词来源较老，表示被画出来的，可以被触摸的绘画作品，可被翻译为图片或者图画；photo的定义是picture made by camera；而image表示一个影像，你看镜子的时候，看到的画面就可以成为image，常为无形，翻译为图像较为妥当。</p>
<p>为了避免图片过大，每个像素中的一个颜色通道只有8个位，256种亮度。LDR图一般储存亮度用的都是整数，而HDR图可以用浮点数来表示亮度，所以精度更高。</p>
<p>以下是一些常见的像素格式：</p>
<ul>
<li>1-bit 灰度，常用于文字</li>
<li>8-bit 固定范围RGB(24 bits total per pixel) 每个颜色通道八个位，也就是256的精度</li>
<li>16-bit 固定范围RGB 常用于专业摄影和打印</li>
<li>16-bit 固定范围灰度 x光或者其他医学影像</li>
<li>32-bit 浮点RGB HDR图像</li>
</ul>
<blockquote>
<p>Second, encoding images with limited precision leads to quantization artifacts, or banding, when the need to round pixel values to the nearest representable value introduces visible jumps in intensity or color.</p>
<p>这是一个英语长句。when the need是一个词组，表示当需要干啥的时候。这里表示当需要把像素取整至最接近的整数的时候。这时会introduces，也就是引入，引入可见的亮度或者颜色跳跃。整句可翻译为：当<strong>需要对有限精度编码的图像中的像素，取整至最接近的整数的时候，会引发亮度或者颜色的跳跃。</strong>（也就是传说中的失真）</p>
</blockquote>
<h3 id="显示器亮度与伽马"><a href="#显示器亮度与伽马" class="headerlink" title="显示器亮度与伽马"></a>显示器亮度与伽马</h3><p>我们可以这么定义：关闭屏幕的时候屏幕为<strong>黑色</strong>，开启屏幕的时候为<strong>白色</strong>。假设输入数据中亮度范围为0~1，那么亮度的一半就是屏幕物理亮度的一半。然而其实人对亮度的敏感度不是线性的，在高亮度的时候，人眼分辨亮度差别的敏感度不高，而在亮度低的时候则相反。所以人眼觉得的中等亮度，其实不是0.5那个亮度。为了不浪费仅有的八位储存空间，我们尽可能地把人眼觉得的中等亮度（据说是0.18）储存为0.5，于是这就需要一个公式来校正。</p>
<p>要在显示器上正确显示亮度，有两点要注意：</p>
<p>显示器显示的亮度与输入的值其实是非线性关系的。什么意思呢？就是当你输入亮度0、0.5、1的时候，显示器亮度可能分别是0，0.25、1。假设输入亮度为$a$，可以得到这样一个公式来表达他们的关系：</p>
<p>display intensity = (maximum intensity)$a^\gamma$</p>
<p>在上面的举例中，$\gamma$就应该为2。</p>
<p>这个公式只能够近似地描述显示器的非线性显示。假设我们知道输入亮度$a$以及输出亮度，这里假设输入亮度为0.5，那么可以得到：</p>
<p>$$0.5 = a^\gamma$$</p>
<p>从而推导出：</p>
<p>$$\gamma = \frac{ln\,0.5}{ln\,a}$$</p>
<blockquote>
<p>顺便这里提一下怎么把log计算转为ln计算<br>$$log_ab = \frac{log_cb}{log_ca} = \frac{ln_b}{lin_a}$$<br>这里第一步叫换底公式。</p>
<p>换底公式的证明：<br>若有对数$log_ab$，现假设$a=n^x$，$b=n^y$，可得：</p>
<p>$x = log_na$, $y = log_nb$<br>所以：<br>$$log_ab = log_{n^x}{n^y}\,\,① $$<br>已知对数基本公式：<br>$$log_{xa}b = \frac{1}{x}log_ab$$<br>和<br>$$log_axb = xlog_ab$$<br>对$①$进行处理可得<br>$$log_ab = log_{n^x}{n^y} = \frac{1}{x}log_n{n^y} = \frac{y}{x}log_nn = \frac{y}{x} = \frac{log_nb}{log_na}$$</p>
</blockquote>
<p>电视上，或者游戏中我们常常可以看到伽马校正的功能，就是在调整$\gamma$的值。</p>
<p>关于gamma校正，可以参考<a href="https://blog.csdn.net/candycat1992/article/details/46228771" target="_blank" rel="noopener">这篇文章</a>。</p>
<p>关于真实的显示还有一点，这里就不讲了。</p>
<h2 id="RGB颜色"><a href="#RGB颜色" class="headerlink" title="RGB颜色"></a>RGB颜色</h2><p>讲光的三原色的混合，莫得谈。</p>
<h2 id="alpha混合"><a href="#alpha混合" class="headerlink" title="alpha混合"></a>alpha混合</h2><p>这部分讲的是blend的内容，也先不提。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/13/CPU内核、用户模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/13/CPU内核、用户模式/" itemprop="url">CPU内核、用户模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-13T09:54:19+08:00">
                2019-02-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/计算机图形学/" itemprop="url" rel="index">
                    <span itemprop="name">计算机图形学</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/02/13/CPU内核、用户模式/" class="leancloud_visitors" data-flag-title="CPU内核、用户模式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="CPU内核、用户模式"><a href="#CPU内核、用户模式" class="headerlink" title="CPU内核、用户模式"></a>CPU内核、用户模式</h1><p>本文由是阅读<a href="https://blog.codinghorror.com/understanding-user-and-kernel-mode/" target="_blank" rel="noopener">该文章</a>做下的笔记。</p>
<p>CPU分内核与用户模式。</p>
<h2 id="三言蔽之"><a href="#三言蔽之" class="headerlink" title="三言蔽之"></a>三言蔽之</h2><p>内核模式下，应用可以直接存取内存，能够执行任何CPU指令。一般来说驱动运行在该模式下。<br>内核模式的应用一旦崩溃，整个操作系统都会崩溃。（所以驱动必须要非常稳定，否则蓝屏常在你身边）</p>
<p>用户模式就是我们一般应用所在的模式。用户模式下，应用想要存取硬件或者内存，必须通过系统API。由于与底层被隔离开来，所以用户模式下的应用崩溃通常不会影响到系统正常运行。</p>
<h2 id="硬件决定"><a href="#硬件决定" class="headerlink" title="硬件决定"></a>硬件决定</h2><p>内核模式和用户模式不是我们定义出来的在软件层面的一个概念，而是由CPU架构所决定的。</p>
<p>通常CPU分为0~3总共四个层。其中我们一般用的是0层内核模式以及3层用户模式。1和2一般少用。</p>
<p>其中，又有人提出-1层，这就是我们平常说的x86硬件下的CPU虚拟化（手机模拟器一般都要开这个）。</p>
<h2 id="驱动"><a href="#驱动" class="headerlink" title="驱动"></a>驱动</h2><p>驱动一般会运行在内核模式<strong>以及</strong>用户模式下。</p>
<p>以下为猜测：</p>
<p>在OpenGL渲染过程中，会在用户模式下维护一个命令队列，切换到内核模式后再一次性发送到驱动，由驱动发送给显卡。</p>
<h2 id="切换代价"><a href="#切换代价" class="headerlink" title="切换代价"></a>切换代价</h2><p>在用户模式和内核模式之间切换，是有代价的，而且代价十分大。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/31/Hexo博客增加live2d看板娘/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/31/Hexo博客增加live2d看板娘/" itemprop="url">Hexo博客增加live2d看板娘</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-31T12:30:20+08:00">
                2019-01-31
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo技术/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/01/31/Hexo博客增加live2d看板娘/" class="leancloud_visitors" data-flag-title="Hexo博客增加live2d看板娘">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Hexo博客增加live2d看板娘"><a href="#Hexo博客增加live2d看板娘" class="headerlink" title="Hexo博客增加live2d看板娘"></a>Hexo博客增加live2d看板娘</h1><h2 id="啥是live2d"><a href="#啥是live2d" class="headerlink" title="啥是live2d"></a>啥是live2d</h2><p>live2d是假3d，根据对应的输入，让模型播放原来设定好的不同的动画。</p>
<p>一个live2d项目至少包括几个元素：</p>
<ul>
<li><strong>纹理贴图</strong> 一般是生成几张1024*1024的合图以及一个合图配置</li>
<li><strong>动作配置</strong> 后缀名为’.mtn’，配置着动画关键帧</li>
<li><strong>model配置</strong> 关联纹理贴图和动作配置</li>
</ul>
<h2 id="安装live2d"><a href="#安装live2d" class="headerlink" title="安装live2d"></a>安装live2d</h2><p>最简单的，还是shell里用npm安装。跑到博客根目录下，右键进入控制台，键入: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install live2d-widget</span><br></pre></td></tr></table></figure>
<p>等安装完之后即可在博客的node_modules里找到新下载来的包。</p>
<h2 id="安装npm库中的live2d模型"><a href="#安装npm库中的live2d模型" class="headerlink" title="安装npm库中的live2d模型"></a>安装npm库中的live2d模型</h2><p>这里假设要安装模型中的看板娘haru。同样是npm安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install live2d-widget-model-haru</span><br></pre></td></tr></table></figure>
<p>之后同样在node_modules里找到live2d-widget-model-haru这个文件夹。</p>
<p>下载下来之后发现有01和02两个子文件夹，里边的package.json都是空的，于是把外头的package.json复制进两个子文件夹覆盖。</p>
<p>接下来讲怎么配置。</p>
<h2 id="配置live2d"><a href="#配置live2d" class="headerlink" title="配置live2d"></a>配置live2d</h2><p>找到项目配置文件<code>_config.yml</code>，在其中插入</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">live2d:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  scriptFrom:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">  pluginRootPath:</span> <span class="string">live2dw/</span></span><br><span class="line"><span class="attr">  pluginJsPath:</span> <span class="string">lib/</span></span><br><span class="line"><span class="attr">  pluginModelPath:</span> <span class="string">assets/</span></span><br><span class="line"><span class="attr">  tagMode:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  log:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  model:</span></span><br><span class="line"><span class="attr">    use:</span> <span class="string">live2d-widget-model-haru/01</span></span><br><span class="line"><span class="attr">  display:</span></span><br><span class="line"><span class="attr">    position:</span> <span class="string">left</span></span><br><span class="line"><span class="attr">    width:</span> <span class="number">150</span></span><br><span class="line"><span class="attr">    height:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">  mobile:</span></span><br><span class="line"><span class="attr">    show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>详细的配置说明书参见：<a href="https://github.com/EYHN/hexo-helper-live2d/blob/master/README.zh-CN.md" target="_blank" rel="noopener">github</a></p>
<p>注意其中的model字段，路径得是你资源中assets文件夹所在的目录。在haru例子中，文件夹大概为</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- live2d-widget-model-haru/</span></span><br><span class="line">    <span class="comment">-- 01/</span></span><br><span class="line">        <span class="comment">-- assets/</span></span><br><span class="line">            <span class="comment">-- moc/</span></span><br><span class="line">            <span class="comment">-- mtn/</span></span><br></pre></td></tr></table></figure>
<p>所以，路径就应该为live2d-widget-model-haru/01。</p>
<p>另，<code>mobile.show</code>字段可以控制看板娘是否在手机端显示。</p>
<h2 id="寻另外的live2d模型"><a href="#寻另外的live2d模型" class="headerlink" title="寻另外的live2d模型"></a>寻另外的live2d模型</h2><p>live2d模型可以在<a href="https://github.com/summerscar/live2dDemo" target="_blank" rel="noopener">这个地方</a>找到。</p>
<p>这里以bilibili的看板娘22酱为例，解释怎么把它变成我们的live2d插件能读的样式。</p>
<p>首先观察到最简单的<code>live2d-widget-model-wanko</code>模型（自己npm可以下载到）中的文件夹内容大概是这样：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- live2d-widget-model-wanko/</span></span><br><span class="line">    <span class="comment">-- assets/</span></span><br><span class="line">        <span class="comment">-- moc/</span></span><br><span class="line">            <span class="comment">-- wanko.1024/</span></span><br><span class="line">            <span class="comment">-- wanko.moc</span></span><br><span class="line">        <span class="comment">-- mtn/   whic means motion</span></span><br><span class="line">            <span class="comment">-- *.mtn</span></span><br><span class="line">        <span class="comment">-- wanko.model.json</span></span><br></pre></td></tr></table></figure>
<p>现在来动手改动它：</p>
<ol>
<li>解压完bilibli娘之后，先创建一个文件夹<code>live2d-widget-model-bilibili</code>，并创建一个assets目录，然后从wanko那边<strong>复制过来一个package.json</strong>。</li>
<li>进入原资源的assets/22目录</li>
<li>把其中的<code>22.1024</code>文件夹和<code>22.v2.moc</code>文件复制到<code>live2d-widget-model-bilibili/assets/moc</code>中</li>
<li>把原资源中<code>motions</code>文件夹里的文件复制到<code>live2d-widget-model-bilibili/assets/mtn</code>中</li>
<li>选择22文件夹中任意一个json文件（代表着22娘的不同装扮）复制到<code>live2d-widget-model-bilibili/assets/</code>中，并更名<code>live2d-widget-model-bilibili.model.json</code>（与本工程同名）</li>
<li><p>更改<code>live2d-widget-model-bilibili.model.json</code>，可以看到里面的路径都是不对的，需要更改路径，譬如</p>
 <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">"textures": [</span><br><span class="line">    - "model": "22.v2.moc",</span><br><span class="line">    + "model": "moc/22.v2.moc",</span><br><span class="line">    // 加上moc/路径前缀</span><br><span class="line">    - "22.1024/closet.default.v2/texture_00.png",</span><br><span class="line">    + "moc/22.1024/closet.default.v2/texture_00.png",</span><br><span class="line">    "idle": [</span><br><span class="line">        &#123;</span><br><span class="line">            - "file": "22.v2.idle-01.mtn",</span><br><span class="line">            + "file": "mtn/22.v2.idle-01.mtn",</span><br><span class="line">            "fade_in": 2000,</span><br><span class="line">            "fade_out": 2000</span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>主要改动三个地方：model路径、纹理路径、motion文件路径。</p>
</li>
</ol>
<p>把这一切做完之后，把<code>live2d-widget-model-bilibili</code>文件夹丢到我们博客的node_modules里边去。</p>
<p>最后，在项目配置文档中把model字段改成<code>live2d-widget-model-bilibili</code>，完事儿。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/30/Unity优化回忆录/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/30/Unity优化回忆录/" itemprop="url">Unity优化回忆录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-30T16:39:18+08:00">
                2019-01-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity3d/" itemprop="url" rel="index">
                    <span itemprop="name">Unity3d</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/01/30/Unity优化回忆录/" class="leancloud_visitors" data-flag-title="Unity优化回忆录">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Unity优化回忆录"><a href="#Unity优化回忆录" class="headerlink" title="Unity优化回忆录"></a>Unity优化回忆录</h1><h2 id="合批优化"><a href="#合批优化" class="headerlink" title="合批优化"></a>合批优化</h2><p>游戏客户端开发必定会讲究一个指标叫做Drawcall，这个词表示的是每一帧<strong>游戏客户端</strong>向<strong>图像引擎</strong>发送的渲染命令个数。每条渲染命令实际上是给图像引擎执行一次渲染过程。可以理解为对某某片元执行了一次draw函数。</p>
<p>先说结论吧：不同的sprite，如果z方向上相邻且图片资源相同（或者合图相同），那么他们的drawcall会被合并。</p>
<h3 id="何为dc"><a href="#何为dc" class="headerlink" title="何为dc"></a>何为dc</h3><p>dc，又称draw calls，有些人也叫他dp（原因不明）</p>
<p>所谓的Draw Call其实是CPU发送给GPU的一条渲染mesh的命令。Draw Call的内容就是一个指向欲渲染的mesh的指针（或者id？称呼whatever），一个Draw Call<strong>不包括</strong>任何材质信息(texture, shader, etc)。</p>
<p>上面提到的材质信息在这里又称渲染状态(render state)。在提交完同一材质信息的所有dc之后，GPU根据当前的材质信息和所有的顶点数据，开始渲染管线的工作。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/29/【MongoDB权威指南】八/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/29/【MongoDB权威指南】八/" itemprop="url">【MongoDB权威指南】八</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-29T16:03:20+08:00">
                2019-01-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端技术/" itemprop="url" rel="index">
                    <span itemprop="name">后端技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/01/29/【MongoDB权威指南】八/" class="leancloud_visitors" data-flag-title="【MongoDB权威指南】八">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="八-分片"><a href="#八-分片" class="headerlink" title="八 分片"></a>八 分片</h1><p>分片$sharding$或者叫分区$partitioning$，表示将数据拆分存放到不同的机器上。</p>
<p>MongoDB支持自动分片。</p>
<p>分片对应用程序来说是透明的。</p>
<h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --nodb</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster = <span class="keyword">new</span> ShardingTest(&#123;<span class="string">'shards'</span>: <span class="number">3</span>, <span class="string">'chunksize'</span>: <span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>创建之后控制台会不断滚新的信息，快速按ctrl+c退出，然后滚到最上看port为何。</p>
<p>再新启一个shell来连接集群</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db = (<span class="keyword">new</span> Mongo(<span class="string">'localhost:20006'</span>)).getDB(<span class="string">'test'</span>)</span><br></pre></td></tr></table></figure>
<p>在当前版本，mongos运行在20006端口。</p>
<p>接下来看集群状态</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.status()</span><br></pre></td></tr></table></figure>
<h3 id="分片依据"><a href="#分片依据" class="headerlink" title="分片依据"></a>分片依据</h3><p>要对一个集合分片，首先要启用分片，然后对<strong>片键</strong>建立索引，最后设置片键。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh.enableSharding(<span class="string">'test'</span>) <span class="comment">// 参数是数据库名称</span></span><br><span class="line">db.users.ensureIndex(&#123;<span class="string">'no'</span>: <span class="number">1</span>&#125;)</span><br><span class="line">sh.shardCollection(<span class="string">'test.users'</span>, &#123;<span class="string">'no'</span>: <span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<p>好了，这个系列到此打住。毕竟是给自己这种后端一窍不通的人看的，暂时也不会转岗去做后端，所以这里把基础概念都了解了就行了。</p>
<p>谢谢各位看官~~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/28/【MongoDB权威指南】七/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/28/【MongoDB权威指南】七/" itemprop="url">【MongoDB权威指南】七</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-28T16:03:20+08:00">
                2019-01-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端技术/" itemprop="url" rel="index">
                    <span itemprop="name">后端技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/01/28/【MongoDB权威指南】七/" class="leancloud_visitors" data-flag-title="【MongoDB权威指南】七">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="七-创建副本"><a href="#七-创建副本" class="headerlink" title="七 创建副本"></a>七 创建副本</h1><h2 id="副本"><a href="#副本" class="headerlink" title="副本"></a>副本</h2><p>使用复制把数据副本保存到多台服务器上。</p>
<p><strong>副本集</strong>是一组服务器，其中有一个主服务器，用于处理客户端请求；还有多个备份服务器用于保存数据副本。如果主服务器崩溃，备份服务器回自动其中一台位新的主服务器。</p>
<h2 id="创建副本集"><a href="#创建副本集" class="headerlink" title="创建副本集"></a>创建副本集</h2><p>启动shell但是不连接到任何mongod。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --nodb</span><br></pre></td></tr></table></figure>
<p>笔者这里使用的是windows10的cmd可以正常执行成功。如果在windows下使用cmder，不知道为啥会报错。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建副本集，这里原书中没有指定name字段，会导致后面两句话执行不成功，所以这里根据报错猜测原因，加入了name字段</span></span><br><span class="line">replicaSet = <span class="keyword">new</span> ReplSetTest(&#123;<span class="string">'nodes'</span>: <span class="number">3</span>, <span class="string">'name'</span>: <span class="string">'test'</span>&#125;)</span><br><span class="line"><span class="comment">// 启动3个mongod进程</span></span><br><span class="line">replicaSet.startSet()</span><br><span class="line"><span class="comment">// 配置复制功能</span></span><br><span class="line">replicaSet.initiate()</span><br></pre></td></tr></table></figure>
<p>现在分别有了三个进程，运行在被分配的三个端口中。这三个端口怎么找呢？就在执行完第一行代码之后，控制台会返回一堆信息，其中接近是最底下的地方那里有个字段叫ports，就是那个。</p>
<p>把这个shell搁置在一旁，然后新启一个shell：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conn1 = <span class="keyword">new</span> Mongo(<span class="string">'localhost:20000'</span>)</span><br><span class="line">primaryDB = conn1.getDB(<span class="string">'test'</span>)</span><br><span class="line"><span class="comment">// 查看副本集状态</span></span><br><span class="line">primaryDB.isMaster()</span><br></pre></td></tr></table></figure>
<p>返回一个dict（js里是这么叫吗。。），其中hosts列表表示该副本集的所有端口，ismaster表示是不是主节点，primary字段表示主节点端口。</p>
<p>由于备份节点的数据可能会落后于主节点，所以备份节点一般是拒绝读取请求的，如果在备份节点上做查询，会得到一个错误提示。</p>
<p>如果真想访问备份服务器，敲</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conn1.setSlaveOk()</span><br></pre></td></tr></table></figure>
<p>最后，关闭副本集</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaSet.stopSet()</span><br></pre></td></tr></table></figure>
<h3 id="自动故障转移"><a href="#自动故障转移" class="headerlink" title="自动故障转移"></a>自动故障转移</h3><p>现在尝试关闭主节点，应该会看到其中一个备份节点会升级为主节点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">primaryDB.adminCommand(&#123;<span class="string">'shutdown'</span>: <span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>之后对第二个链接调用idMaster函数可以看到它已经变为主节点。</p>
<h2 id="配置副本集"><a href="#配置副本集" class="headerlink" title="配置副本集"></a>配置副本集</h2><p>上一节是在自己的localhost上面尝试建立测试用的一个副本集，现在来看假如有三台linux机器，怎么在其上搭建副本集。</p>
<p>假设我们所在的机器是server-1，另有两台机器是server-2和server-3。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> on local machine(server-1)</span><br><span class="line">mongod --replSet spock -f mongod.conf --fork</span><br><span class="line"><span class="meta">#</span> link to server-2</span><br><span class="line">ssh server-2</span><br><span class="line">mongod --replSet spock -f mongod.conf --fork</span><br><span class="line">exit</span><br><span class="line"><span class="meta">#</span> link to server-3</span><br><span class="line">ssh server-3</span><br><span class="line">mongod --replSet spock -f mongod.conf --fork</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p>为了让三个mongod知道彼此的存在，需要设置。shell中键入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">config = &#123;</span><br><span class="line">    <span class="string">'_id'</span>: <span class="string">'spock'</span>,</span><br><span class="line">    <span class="string">'members'</span>: [</span><br><span class="line">        &#123;<span class="string">'_id'</span>: <span class="number">0</span>, <span class="string">'host'</span>: <span class="string">'server-1:27017'</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'_id'</span>: <span class="number">1</span>, <span class="string">'host'</span>: <span class="string">'server-2:27017'</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'_id'</span>: <span class="number">2</span>, <span class="string">'host'</span>: <span class="string">'server-3:27017'</span>&#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意，上面的spock是集合的名字，不要再傻傻去查翻译了。</p>
</blockquote>
<p>之后对主节点进行初始化。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db = (<span class="keyword">new</span> Mongo(<span class="string">'server-1:27017'</span>)).getDB(<span class="string">'test'</span>)</span><br><span class="line">rs.initiate(config) <span class="comment">// 等价于 db.adminCommand(&#123;'replSetInitiate': config&#125;)</span></span><br></pre></td></tr></table></figure>
<p>其中rs这个变量是个全局变量，包含与复制相关的辅助函数。</p>
<blockquote>
<p>需要确保每台机器可以连接到其他机器。</p>
<p>允许所有节点都在同一台机子上。</p>
</blockquote>
<h2 id="修改副本集配置"><a href="#修改副本集配置" class="headerlink" title="修改副本集配置"></a>修改副本集配置</h2><h3 id="添加成员和移除成员"><a href="#添加成员和移除成员" class="headerlink" title="添加成员和移除成员"></a>添加成员和移除成员</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加</span></span><br><span class="line">rs.add(<span class="string">'server-4:27017'</span>)</span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line">rs.remove(<span class="string">'server-4:27017'</span>)</span><br><span class="line"><span class="comment">// 查看当前状态</span></span><br><span class="line">rs.config()</span><br></pre></td></tr></table></figure>
<p>做remove操作的时候会在控制台打印很多错误信息，这很正常。</p>
<p>每次更新配置之后<code>rs.config()</code>返回的version字段都会加一。</p>
<p>假设要直接更改config表：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> config = rs.config()</span><br><span class="line">config.members[<span class="number">1</span>].host = <span class="string">'server-2:4444'</span></span><br><span class="line">rs.reconfig(config)</span><br></pre></td></tr></table></figure>
<p>直接改。</p>
<h2 id="主节点选举机制"><a href="#主节点选举机制" class="headerlink" title="主节点选举机制"></a>主节点选举机制</h2><p>太长不看。</p>
<hr>
<p>下面讲副本集的组成。</p>
<h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><p>MongoDB的复制功能是使用操作日志oplog实现的，这份日志包含了主节点的每次写操作。oplog是主节点local数据库中的一个固定结合。</p>
<p>备份节点同样也拥有一份oplog。在执行完主节点的oplog之后，会更新进自己的oplog。为了避免过程中出问题重新执行oplog会重复生效操作，MongoDB执行oplog中的同一操作，只会执行一次。</p>
<p>通常来说每个写操作只影响一个文档，只会产生一条oplog日志。但是如果是执行像db.coll.remove()这种操作，就会产生多条数据（条数与coll中文档个数相当）</p>
<h3 id="初始化同步"><a href="#初始化同步" class="headerlink" title="初始化同步"></a>初始化同步</h3><p>副本集中的成员启动之后，会检查是否能从某个成员那里进行同步（增量），如果不行，那么会从另一个成员那里进行完整的数据复制（全量）。这就是初始化同步的过程。</p>
<p>具体步骤如下：</p>
<ol>
<li>删除自身所有的数据库</li>
<li>选择一个同步源，克隆数据</li>
<li>检查是否有文档需要重新克隆，重新克隆克隆过程中发生改动的文档，这是第一个oplog步骤</li>
<li>记录上一个步骤的oplog</li>
<li>创建索引</li>
<li>将创建索引时的oplog同步</li>
<li>切换到普通同步状态</li>
</ol>
<h3 id="处理落后的数据"><a href="#处理落后的数据" class="headerlink" title="处理落后的数据"></a>处理落后的数据</h3><p>如果数据落后于同步源台太多，那么这个备份节点就是陈旧的$stale$。</p>
<p>一个陈旧节点会尝试查看其他成员，如果有某个成员的oplog足够详尽，能够让它追上步伐，那就用他的oplog来同步数据。如果找不到这么一台机器，那就需要完全同步。</p>
<p>为了避免完全同步，最好让主节点能够用比较大的oplog，毕竟磁盘不用钱的。</p>
<h2 id="心跳"><a href="#心跳" class="headerlink" title="心跳"></a>心跳</h2><p>为了知道副本集的状态，需要每隔2秒向其他成员发出一个心跳请求。最重要的功能之一就是让主节点知道自己是否符合条件，如果不符合就会退化成备份节点。</p>
<h3 id="成员状态"><a href="#成员状态" class="headerlink" title="成员状态"></a>成员状态</h3><ul>
<li><strong>STARTUP</strong></li>
<li><strong>STARTUP2</strong></li>
<li><strong>RECOVERING</strong></li>
<li><strong>ARBITER</strong></li>
<li><strong>DOWN</strong></li>
<li><strong>UNKNOWN</strong></li>
<li><strong>REMOVED</strong></li>
<li><strong>ROLLBACK</strong></li>
<li><strong>FATAL</strong></li>
</ul>
<h2 id="选举"><a href="#选举" class="headerlink" title="选举"></a>选举</h2><p>选举发生时机：其中一个成员无法到达（reach）主节点，它会向自己所有能reach的成员发通知，说希望被选举为主节点。其他节点会进行判断，看那个节点符不符合参与选举的条件（其中有一个原因可能是主节点其实在正常运行）。如果符合选举条件，就会开始选举。</p>
<p>一般而言选举非常快，可能只要几毫秒。运气不好也就几分钟。</p>
<h2 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h2><p>在主节点在写入的时候崩溃之后，会选出新的节点。原主节点恢复之后会尝试同步刚才崩溃那次操作，如果这个操作在新的主节点并不存在，那么原主节点就会回滚。</p>
<p>如果回滚失败（数据量过大），就会进行完全同步。</p>
<p>关于副本集的更多内容在这里不做记录，等成为运维之后再说吧。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/25/【MongoDB权威指南】六/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/25/【MongoDB权威指南】六/" itemprop="url">【MongoDB权威指南】六</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-25T16:03:20+08:00">
                2019-01-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端技术/" itemprop="url" rel="index">
                    <span itemprop="name">后端技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/01/25/【MongoDB权威指南】六/" class="leancloud_visitors" data-flag-title="【MongoDB权威指南】六">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="六-应用程序设计"><a href="#六-应用程序设计" class="headerlink" title="六 应用程序设计"></a>六 应用程序设计</h1><h2 id="范式化与反范式化"><a href="#范式化与反范式化" class="headerlink" title="范式化与反范式化"></a>范式化与反范式化</h2><p>所谓<strong>范式化</strong>$normalization$：把数据分散到多个不同的集合（表），不同集合（表）之间可以相互引用数据。但是这块被引用的数据只存在于一个集合之中，需要修改时只需要改一个文档就好。适合数据经常变动的情况，如果数据不经常变化，就没必要用范式化。</p>
<p>MongoDB并不存在join工具。</p>
<p>反范式化$denormalization$：每个集合都有一个文档副本。</p>
<h3 id="基数"><a href="#基数" class="headerlink" title="基数"></a>基数</h3><p>一个集合中包含的对其他集合的引用数量叫做基数。</p>
<h3 id="模式迁移"><a href="#模式迁移" class="headerlink" title="模式迁移"></a>模式迁移</h3><p>有时候需求变动，需要加入新的字段或者删除旧有字段。为了避免兼容性问题，可以在每个文档中加入version字段。</p>
<p>当字段版本有变动的时候，也可以选择做个<del>马杀鸡</del>数据迁移。但是要注意MongoDB的多文档更新<code>updateMany</code>不是原子性的，一旦执行过程中发生崩溃，就有可能出现一些文档更新成功，一些文档尚未更新的情况。</p>
<h3 id="不适合MongoDB的场景"><a href="#不适合MongoDB的场景" class="headerlink" title="不适合MongoDB的场景"></a>不适合MongoDB的场景</h3><ul>
<li>不支持事务</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/24/【MongoDB权威指南】五/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="左未">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="左未的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/24/【MongoDB权威指南】五/" itemprop="url">【MongoDB权威指南】五</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-24T16:03:20+08:00">
                2019-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/后端技术/" itemprop="url" rel="index">
                    <span itemprop="name">后端技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/01/24/【MongoDB权威指南】五/" class="leancloud_visitors" data-flag-title="【MongoDB权威指南】五">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="五-聚合"><a href="#五-聚合" class="headerlink" title="五 聚合"></a>五 聚合</h1><p>谈数据库呢，就一定要谈聚合啦。</p>
<h2 id="聚合框架"><a href="#聚合框架" class="headerlink" title="聚合框架"></a>聚合框架</h2><p>用于对集合中的文档进行变换和组合。处理文档的东西叫做管道pipeline，管道由多个构件构成。构建包括了：filtering, projection, grouping, sorting, limiting, skipping。</p>
<p>假设有如此需求：</p>
<ol>
<li>投影出所有作者</li>
<li>按照作者名称排序，统计每个作者名字出现次数</li>
<li>根据作者名字出现次数降序排列</li>
<li>返回结果限制为前五个</li>
</ol>
<p>步骤为：</p>
<ol>
<li><code>{&#39;$project&#39;: {&#39;author&#39;: 1}}</code><br>只投影出author字段。</li>
<li><code>{&#39;$group: {&#39;_id&#39;: &#39;$author&#39;, &#39;count&#39;: {&#39;sum&#39;: 1}}&#39;}</code><br>大家都知道group是干嘛用的了，就是把所有文档浓缩成一份的意思。合并文档的根据在这里被规定为author，并为每个文档新增字段count，内容是同作者名的文档的出现次数。</li>
<li><code>{&#39;$sort&#39;: {&#39;count&#39;: -1}}</code><br>根据count进行降序排列。</li>
<li><code>{&#39;$limit&#39;: 5}</code><br>只要前五个文档。</li>
</ol>
<p>要构建一个管道，需要把各种构件条件传入<code>aggregate()</code>函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.test.aggregate(&#123;<span class="string">'$project'</span>: &#123;<span class="string">'author'</span>: <span class="number">1</span>&#125;&#125;, &#123;<span class="string">'$group: &#123;'</span>_id<span class="string">': '</span>$author<span class="string">', '</span>count<span class="string">': &#123;'</span>$sum<span class="string">': 1&#125;&#125;,</span></span><br><span class="line"><span class="string">&#123;'</span>$sort<span class="string">': &#123;'</span>count<span class="string">': -1&#125;&#125;, &#123;'</span>$limit<span class="string">': 5&#125;)</span></span><br></pre></td></tr></table></figure>
<h2 id="管道操作符"><a href="#管道操作符" class="headerlink" title="管道操作符"></a>管道操作符</h2><h3 id="match"><a href="#match" class="headerlink" title="$match"></a>$match</h3><p>相当于条件筛选，可以看作是find。</p>
<p>应尽可能地把match操作提前，减少后面的聚合工作量。</p>
<h3 id="project"><a href="#project" class="headerlink" title="$project"></a>$project</h3><p>投影。</p>
<p>默认的投影操作还会加入_id这个字段，如果不想要就把它设置为0。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.test.aggregate(&#123;<span class="string">'$project'</span>: &#123;<span class="string">'age'</span>: <span class="number">1</span>, <span class="string">'_id'</span>: <span class="number">0</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>除了将想要返回的字段设置成1，还可以用别的方式进行改名，比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.test.aggregate(&#123;<span class="string">'$project'</span>: &#123;<span class="string">'userId'</span>: <span class="string">'$_id'</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>就是将_id映射为userId。</p>
<p>也可以映射数组中的第n个元素，只要<code>{&#39;$project&#39;: {&#39;userId&#39;: &#39;$fieldname.n&#39;}}</code>。</p>
<p>有个问题，在映射为别的名字之后，就无法使用原来能使用的索引了，所以要用sort，就别乱映射成别的名字。</p>
<p>映射的基础功能是筛选一些自己要的字段，但是之外还能使用各种表达式来做更高阶的操作。</p>
<h4 id="数学表达式"><a href="#数学表达式" class="headerlink" title="数学表达式"></a>数学表达式</h4><p>举例用法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.test.aggregate(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'project'</span>: &#123;</span><br><span class="line">            <span class="string">'totalPay'</span>: &#123;</span><br><span class="line">                <span class="string">'$add'</span> [<span class="string">'$salary'</span>, <span class="string">'$bonus'</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>有加减乘除余5种算法：</p>
<ul>
<li><strong>$add</strong></li>
<li><strong>$subtract</strong></li>
<li><strong>$multiply</strong></li>
<li><strong>$divide</strong></li>
<li><strong>$mod</strong></li>
</ul>
<h4 id="日期表达式"><a href="#日期表达式" class="headerlink" title="日期表达式"></a>日期表达式</h4><p>我们当然知道数据库中有一种数据类型叫做date。运用日期表达式，你可以从某个日期中提取出年日月等你所需要的信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.test.aggregate(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'$project'</span>: &#123;</span><br><span class="line">            <span class="string">'theMonth'</span>: &#123;<span class="string">'$month'</span>: <span class="string">'$theDate'</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>除了单纯的投影操作之外，还能结合算术表达式计算时间跨度。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.test.aggregate(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'$project'</span>: &#123;</span><br><span class="line">            <span class="string">'duration'</span>: &#123;</span><br><span class="line">                <span class="string">'substract'</span>: [</span><br><span class="line">                    &#123;<span class="string">'$year'</span>: <span class="keyword">new</span> <span class="built_in">Date</span>()&#125;,</span><br><span class="line">                    &#123;<span class="string">'$year'</span>: <span class="string">'$theDate'</span>&#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="字符表达式"><a href="#字符表达式" class="headerlink" title="字符表达式"></a>字符表达式</h4><ul>
<li><strong>$substr</strong> 对象是数组，数组里是参数，第一个参数是字符串来源，第二个是开始index，第三个是结束index</li>
<li><strong>$concat</strong></li>
<li><strong>$toLower</strong></li>
<li><strong>$toUpper</strong></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.test.aggregate(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'$project'</span>: &#123;</span><br><span class="line">            <span class="string">'email'</span>: &#123;</span><br><span class="line">                <span class="string">'$concat'</span>: [</span><br><span class="line">                    &#123;<span class="string">'$substr'</span>: [<span class="string">'$firstName'</span>, <span class="number">0</span>, <span class="number">1</span>]&#125;,</span><br><span class="line">                    <span class="string">'.'</span>,</span><br><span class="line">                    <span class="string">'$lastName'</span>,</span><br><span class="line">                    <span class="string">'@example.com'</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="逻辑表达式"><a href="#逻辑表达式" class="headerlink" title="逻辑表达式"></a>逻辑表达式</h4><ul>
<li><strong>$cmp</strong></li>
<li><strong>$strcasecmp</strong></li>
<li><strong>$and</strong></li>
<li><strong>$or</strong></li>
<li><strong>$not</strong></li>
</ul>
<p>都没啥说的，简单易懂，不懂是傻Ⅹ。注意参数都是用数组形式包起来的就好。</p>
<ul>
<li><strong>$cond</strong>[booleanExpr, trueExpr, falseExpr] 如果booleanExpr结果是真，就返回trueExpr，否则返回falseExpr</li>
</ul>
<h3 id="group"><a href="#group" class="headerlink" title="$group"></a>$group</h3><p>分组。所谓分组，我尽量用人话描述一遍：</p>
<p>假设你要对属性x进行分组，在你的集合中x总共存在a、b、c三种情况。那么分组后返回给你的就是三个文档。文档的内容是什么呢？如果没有定义，那就是没有。但是如果比如定义了一个sum操作符，就可以累计所有同个x中的y字段的总和。</p>
<h4 id="算术操作符"><a href="#算术操作符" class="headerlink" title="算术操作符"></a>算术操作符</h4><ul>
<li><strong>$sum</strong></li>
<li><strong>$avg</strong></li>
</ul>
<p>group操作的参数是一个dict，其中必定有一个字段叫做<code>_id</code>，字段值就是你的分组依据，若是上文那种情况，那就是x。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.test.aggregate(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'$group'</span>: &#123;</span><br><span class="line">            <span class="string">'_id'</span>: <span class="string">'$x'</span>,</span><br><span class="line">            <span class="string">'count'</span>: &#123;<span class="string">'$sum'</span>: <span class="string">'$y'</span>&#125;, <span class="comment">// 所有y字段的总和</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="极限操作符"><a href="#极限操作符" class="headerlink" title="极限操作符"></a>极限操作符</h4><p><del>在爆发的边缘试探。</del></p>
<ul>
<li><strong>$max</strong></li>
<li><strong>$min</strong></li>
<li><strong>$first</strong></li>
<li><strong>$last</strong></li>
</ul>
<p>假设求每个班里面分数最高的人。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.test.aggregate(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'$group'</span>: &#123;</span><br><span class="line">            <span class="string">'_id'</span>: <span class="string">'$classNo'</span>,</span><br><span class="line">            <span class="string">'bestStudent'</span>: &#123;</span><br><span class="line">                <span class="string">'$max'</span>: <span class="string">'$score'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>如果上面的group已经根据score排过序了，那么用first或者last的性能会更高一些（这不是废话）。</p>
<h3 id="unwind"><a href="#unwind" class="headerlink" title="$unwind"></a>$unwind</h3><p>那么这里的最大的问题就是，这个英语是啥意思？！说到wind就想起风，风是它的名词意思，它的动词意思是缠绕，可以想象一下一股龙卷风在缠绕。unwind就是接触缠绕的意思，在MongoDB中可以把数组中的每一个值拆分成为单独的文档。</p>
<p>暂时想不出有什么卵用，反正记得有这么一个拆分数组为多个独立文档的功能就好了。</p>
<h3 id="sort"><a href="#sort" class="headerlink" title="$sort"></a>$sort</h3><p>这都不用说啦。</p>
<h3 id="limit"><a href="#limit" class="headerlink" title="$limit"></a>$limit</h3><p>见前文。</p>
<h3 id="skip"><a href="#skip" class="headerlink" title="$skip"></a>$skip</h3><p>见前文。</p>
<h3 id="管道使用优化"><a href="#管道使用优化" class="headerlink" title="管道使用优化"></a>管道使用优化</h3><p>如果需要排序，那就尽量在第一阶段排序，利用好索引，索引只能在原有的集合中使用。如果单一的聚合操作内存占用超过20%，直接报错。</p>
<h2 id="MapReduce"><a href="#MapReduce" class="headerlink" title="MapReduce"></a>MapReduce</h2><p>非常灵活的聚合工具，缺点是慢，不应该在项目运行过程中跑。</p>
<p>没啥了解的欲望，<code>$skip: 1</code>。</p>
<h2 id="聚合命令"><a href="#聚合命令" class="headerlink" title="聚合命令"></a>聚合命令</h2><h3 id="count"><a href="#count" class="headerlink" title="count"></a>count</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.test.count()</span><br></pre></td></tr></table></figure>
<h3 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h3><p>返回一个数组，内容是某个字段的所有不同结果（排除了相同的结果）。</p>
<p>假设集合名称test，要找出所有不同的age。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand(&#123;<span class="string">'distinct'</span>: <span class="string">'test'</span>, <span class="string">'key'</span>: <span class="string">'age'</span>&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="group-1"><a href="#group-1" class="headerlink" title="group"></a>group</h3><p>不想看。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/default_avatar.png" alt="左未">
            
              <p class="site-author-name" itemprop="name">左未</p>
              <p class="site-description motion-element" itemprop="description">左未的blog</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">左未</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  











// 
  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("7CaWPI6HXpR1CiqpYnyY0JdE-gzGzoHsz", "rB1Vxs2fw7BXYUN9iyRcwfM3");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/unitychan.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":200,"vOffset":-150},"mobile":{"show":false,"scale":0.2,"motion":true},"react":{"opacityDefault":0.7,"opacityOnHover":0.2}});</script></body>
</html>
